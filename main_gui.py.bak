import sys
import json
import os
import traceback
from pathlib import Path
import tkinter as tk
from tkinter import ttk, filedialog, scrolledtext, messagebox
import threading
import re

# ì´ëª¨í‹°ì½˜ ì„¤ì •
EMOJI = {
    "dangerous": "ğŸš¨ ìœ„í—˜",
    "suspicious": "âš ï¸ ì£¼ì˜",
    "legitimate": "âœ… ì•ˆì „",
    "error": "âŒ ì˜¤ë¥˜"
}

class EmailAnalyzerGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("ì´ë©”ì¼ ë¶„ì„ ì‹œìŠ¤í…œ")
        self.root.geometry("800x700")
        self.root.minsize(700, 600)
        
        # ë³€ìˆ˜ ì´ˆê¸°í™”
        self.email_path = tk.StringVar()
        self.base_dir = Path(__file__).parent
        self.keywords_dir = self.base_dir / "mail_body" / "keywords"
        
        # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
        os.makedirs(self.keywords_dir, exist_ok=True)
        
        # í•„ìš”í•œ ê¸°ë³¸ í‚¤ì›Œë“œ íŒŒì¼ ìƒì„±
        self._create_default_keywords_if_needed()
        
        # GUI ìƒì„±
        self.create_widgets()
        
        # í‚¤ì›Œë“œ ê´€ë¦¬ ë„êµ¬ ê²½ë¡œ
        self.keyword_manager_path = self.base_dir / "header_keyword_add.py"
    
    def create_widgets(self):
        # ë©”ì¸ í”„ë ˆì„
        main_frame = ttk.Frame(self.root, padding=10)
        main_frame.pack(fill=tk.BOTH, expand=True)
        
        # ìƒë‹¨ í”„ë ˆì„ (íŒŒì¼ ì„ íƒ)
        top_frame = ttk.LabelFrame(main_frame, text="ì´ë©”ì¼ íŒŒì¼ ì„ íƒ", padding=5)
        top_frame.pack(fill=tk.X, padx=5, pady=5)
        
        ttk.Entry(top_frame, textvariable=self.email_path, width=60).pack(side=tk.LEFT, padx=5, fill=tk.X, expand=True)
        ttk.Button(top_frame, text="íŒŒì¼ ì°¾ê¸°", command=self.browse_file).pack(side=tk.LEFT, padx=5)
        ttk.Button(top_frame, text="ë¶„ì„ ì‹œì‘", command=self.start_analysis).pack(side=tk.LEFT, padx=5)
        
        # ë„êµ¬ í”„ë ˆì„ (í‚¤ì›Œë“œ ê´€ë¦¬)
        tools_frame = ttk.Frame(main_frame)
        tools_frame.pack(fill=tk.X, padx=5, pady=5)
        
        ttk.Button(tools_frame, text="í—¤ë” í‚¤ì›Œë“œ ê´€ë¦¬ ë„êµ¬", command=self.open_keyword_manager).pack(side=tk.LEFT, padx=5)
        ttk.Button(tools_frame, text="ê²°ê³¼ í´ë” ì—´ê¸°", command=self.open_result_folder).pack(side=tk.LEFT, padx=5)
        
        # ê²°ê³¼ íƒ­
        self.tab_control = ttk.Notebook(main_frame)
        self.tab_control.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        # ê²°ê³¼ ìš”ì•½ íƒ­
        summary_tab = ttk.Frame(self.tab_control)
        self.tab_control.add(summary_tab, text="ë¶„ì„ ìš”ì•½")
        
        # ìš”ì•½ ê²°ê³¼ í…ìŠ¤íŠ¸ ì˜ì—­
        self.summary_text = scrolledtext.ScrolledText(summary_tab, wrap=tk.WORD, width=80, height=20, font=('Consolas', 10))
        self.summary_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        self.summary_text.config(state=tk.DISABLED)
        
        # ìƒì„¸ ë¡œê·¸ íƒ­
        log_tab = ttk.Frame(self.tab_control)
        self.tab_control.add(log_tab, text="ìƒì„¸ ë¡œê·¸")
        
        # ë¡œê·¸ í…ìŠ¤íŠ¸ ì˜ì—­
        self.log_text = scrolledtext.ScrolledText(log_tab, wrap=tk.WORD, width=80, height=20, font=('Consolas', 9))
        self.log_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        self.log_text.config(state=tk.DISABLED)
        
        # ìƒíƒœ í‘œì‹œì¤„
        self.status_var = tk.StringVar()
        self.status_var.set("ì¤€ë¹„ë¨")
        status_bar = ttk.Label(main_frame, textvariable=self.status_var, relief=tk.SUNKEN, anchor=tk.W)
        status_bar.pack(fill=tk.X, side=tk.BOTTOM, padx=5, pady=2)
        
        # í”„ë¡œê·¸ë ˆìŠ¤ ë°”
        self.progress = ttk.Progressbar(main_frame, orient=tk.HORIZONTAL, length=100, mode='indeterminate')
        self.progress.pack(fill=tk.X, side=tk.BOTTOM, padx=5, pady=2)
    
    def browse_file(self):
        filetypes = [
            ("ì´ë©”ì¼ íŒŒì¼", "*.eml"),
            ("ëª¨ë“  íŒŒì¼", "*.*")
        ]
        filepath = filedialog.askopenfilename(filetypes=filetypes, title="ë¶„ì„í•  ì´ë©”ì¼ íŒŒì¼ ì„ íƒ")
        if filepath:
            self.email_path.set(filepath)
    
    def start_analysis(self):
        filepath = self.email_path.get()
        if not filepath:
            messagebox.showwarning("ê²½ê³ ", "ì´ë©”ì¼ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return
        
        # í…ìŠ¤íŠ¸ ì˜ì—­ ì´ˆê¸°í™”
        self.clear_text_areas()
        
        # ìƒíƒœ ì—…ë°ì´íŠ¸
        self.status_var.set("ë¶„ì„ ì¤‘...")
        self.progress.start(10)
        
        # ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ë¶„ì„ ì‹¤í–‰
        threading.Thread(target=self.run_analysis, args=(filepath,), daemon=True).start()
    
    def run_analysis(self, email_path):
        try:
            email_path = Path(email_path)
            if not email_path.exists():
                self.update_log(f"{EMOJI['error']} ì´ë©”ì¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {email_path}")
                return
            
            # ì„¸ì…˜ ID ìƒì„± (íŒŒì¼ëª… ê¸°ë°˜)
            session_id = f"{email_path.stem}_{os.urandom(4).hex()}"
            
            # ì„¸ì…˜ë³„ ê²°ê³¼ ë””ë ‰í† ë¦¬ ìƒì„±
            result_dir = self.base_dir / "analysis_result" / session_id
            os.makedirs(result_dir, exist_ok=True)
            
            # ì„¸ì…˜ë³„ ì²¨ë¶€íŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„±
            attachments_dir = result_dir / "attachments"
            os.makedirs(attachments_dir, exist_ok=True)
            
            # í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œë¥¼ ì‹œìŠ¤í…œ ê²½ë¡œì— ì¶”ê°€
            sys.path.insert(0, str(self.base_dir))
            
            # í†µí•© ë¶„ì„ê¸° ê°€ì ¸ì˜¤ê¸°
            from email_analyzer.integration import IntegratedAnalyzer
            
            # ë¡œê¹… ë¦¬ë‹¤ì´ë ‰ì…˜ ì„¤ì •
            import logging
            logger = logging.getLogger()
            
            # ì›ë˜ í•¸ë“¤ëŸ¬ ì €ì¥
            original_handlers = logger.handlers.copy()
            
            # ë¡œê·¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í´ë˜ìŠ¤
            class LogHandler(logging.Handler):
                def __init__(self, callback):
                    super().__init__()
                    self.callback = callback
                
                def emit(self, record):
                    log_entry = self.format(record)
                    self.callback(log_entry)
            
            # ë¡œê·¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
            logger.addHandler(LogHandler(self.update_log))
            
            # ë¶„ì„ê¸° ì´ˆê¸°í™”
            analyzer = IntegratedAnalyzer(
                keywords_dir=self.keywords_dir,
                result_dir=result_dir,
                attachments_dir=attachments_dir
            )
            
            # ì´ë©”ì¼ ë¶„ì„ ì‹¤í–‰
            result = analyzer.analyze_email(email_path)
            
            # ë¡œê¹… í•¸ë“¤ëŸ¬ ë³µì›
            logger.handlers = original_handlers
            
            # ê²°ê³¼ ì¶œë ¥
            self.display_results(result)
            
            # ìƒíƒœ ì—…ë°ì´íŠ¸
            self.root.after(0, lambda: self.status_var.set(f"ë¶„ì„ ì™„ë£Œ: {email_path.name}"))
            
        except Exception as e:
            error_msg = f"\n{EMOJI['error']} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n"
            error_msg += "="*50 + "\n"
            
            # ì˜¤ë¥˜ ìœ í˜•ë³„ ì²˜ë¦¬
            if isinstance(e, FileNotFoundError):
                error_msg += "íŒŒì¼ ì‹œìŠ¤í…œ ì˜¤ë¥˜:\n"
                error_msg += f" - {str(e)}\n"
            elif isinstance(e, json.JSONDecodeError):
                error_msg += "í‚¤ì›Œë“œ íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜:\n"
                error_msg += f" - {e.doc}\n"
                error_msg += f" - ìœ„ì¹˜: {e.pos}, ì¤„: {e.lineno}, ì—´: {e.colno}\n"
                error_msg += f" - ìˆ˜ì • ë°©ë²•: JSON í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”. ì¼ë°˜ì ìœ¼ë¡œ ë”°ì˜´í‘œ, ì‰¼í‘œ, ê´„í˜¸ ë“±ì˜ ì˜¤ë¥˜ì…ë‹ˆë‹¤.\n"
            else:
                error_msg += "ì‹œìŠ¤í…œ ì˜¤ë¥˜:\n"
                error_msg += f" - {type(e).__name__}: {str(e)}\n"
            
            error_msg += "\nìƒì„¸ ì˜¤ë¥˜ ì¶”ì :\n"
            error_msg += traceback.format_exc()
            
            self.update_log(error_msg)
            self.update_summary(f"{EMOJI['error']} ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n{str(e)}")
        
        finally:
            # í”„ë¡œê·¸ë ˆìŠ¤ë°” ì¤‘ì§€
            self.root.after(0, self.progress.stop)
    
    def display_results(self, result):
        # í•„ìš”í•œ ëª¨ë“ˆ import
        import re
        import sys
        from pathlib import Path
        
        # ìš”ì•½ ê²°ê³¼ ìƒì„±
        summary = "[ë¶„ì„ ê²°ê³¼]\n\n"
        risk_score = result.get('risk_score', 0)
        risk_threshold = result.get('risk_threshold', 70)
        
        # ë„ë©”ì¸ í‰íŒ ì¡°ì • ì •ë³´ í™•ì¸
        domain_reputation_adjusted = result.get('domain_reputation_adjusted', False)
        domain_age_days = result.get('domain_age_days', None)
        
        # ë„ë©”ì¸ ë‚˜ì´ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° í—¤ë”ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if not domain_age_days and result.get('header') and result['header'].get('details') and result['header']['details'].get('domain_info'):
            domain_info = result['header']['details']['domain_info']
            domain_age_days = domain_info.get('domain_age_days')
        
        # ë„ë©”ì¸ í‰íŒì´ ì¡°ì •ëœ ê²½ìš° í‘œì‹œ
        if domain_reputation_adjusted and domain_age_days:
            summary += f"[ì¡°ì •] ë„ë©”ì¸ì´ {domain_age_days}ì¼ ëœ ì•ˆì •ì ì¸ ë„ë©”ì¸ìœ¼ë¡œ íŒë‹¨ë˜ì–´ í‰íŒ ì˜ì‹¬ ì ìˆ˜(-25)ê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n"
        
        # íŒì • ê²°ê³¼ í™•ì¸ (analyze_email í•¨ìˆ˜ ê²°ê³¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        verdict = result.get('verdict', 'legitimate')
        
        # íŒì • ê²°ê³¼ í‘œì‹œ
        summary += f"[ìµœì¢… íŒì •] {EMOJI.get(verdict, EMOJI['legitimate'])}\n"
        if verdict == 'dangerous':
            summary += " - ì´ ì´ë©”ì¼ì€ ë†’ì€ ìœ„í—˜ì„±ìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤. ì¦‰ì‹œ ì‚­ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.\n"
        elif verdict == 'suspicious':
            summary += " - ì´ ì´ë©”ì¼ì€ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë‚´ìš©ì„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
        else:
            summary += " - ì´ ì´ë©”ì¼ì€ ì•ˆì „í•œ ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.\n"
        
        # ì œëª© ìœ„í—˜ í‚¤ì›Œë“œ ì •ë³´ ì¶”ê°€ - ë¡œê·¸ ë° ê°„ì ‘ ì¶”ì¶œ
        subject_keywords_count = 0
        found_keywords = []
        subject = ""
        
        # ì œëª© ê°€ì ¸ì˜¤ê¸°
        if 'subject' in result:
            subject = result['subject']
        elif 'metadata' in result and 'Subject' in result['metadata']:
            subject = result['metadata']['Subject']
        
        # ë¡œê·¸ì—ì„œ ì œëª© ê°€ì ¸ì˜¤ê¸° (ìœ„ì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš°)
        if not subject and hasattr(self, 'log_text'):
            log_content = self.log_text.get("1.0", "end")
            subject_match = re.search(r'ì œëª©: (.+?)$', log_content, re.MULTILINE)
            if subject_match:
                subject = subject_match.group(1).strip()
        
        # ì œëª© í‚¤ì›Œë“œ ìˆ˜ íŒŒì•… - resultì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
        for reason in result.get('reasons', []):
            if "ì œëª©ì— ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í‚¤ì›Œë“œ" in reason:
                match = re.search(r'ì œëª©ì— ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í‚¤ì›Œë“œ (\d+)ê°œ', reason)
                if match:
                    subject_keywords_count = int(match.group(1))
                    break
        
        # integration.pyì˜ subject_suspicious_patterns ê°€ì ¸ì˜¤ê¸°
        try:
            # í”„ë¡œì íŠ¸ ê²½ë¡œ êµ¬í•˜ê¸°
            project_root = Path(__file__).parent
            integration_path = project_root / "email_analyzer" / "integration.py"
            
            if integration_path.exists():
                with open(integration_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # subject_suspicious_patterns ë³€ìˆ˜ ì°¾ê¸°
                pattern = r"subject_suspicious_patterns\s*=\s*\[(.*?)\]"
                matches = re.search(pattern, content, re.DOTALL)
                
                if matches:
                    patterns_block = matches.group(1)
                    
                    # ê° íŒ¨í„´ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
                    keywords_from_patterns = []
                    for line in patterns_block.split('\n'):
                        line = line.strip()
                        if line.startswith('r\'') or line.startswith('r"'):
                            # ì •ê·œì‹ íŒ¨í„´ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
                            pattern_match = re.search(r'r[\'"](.+?)[\'"]', line)
                            if pattern_match:
                                pattern = pattern_match.group(1)
                                # '|' êµ¬ë¶„ìë¡œ ë‚˜ëˆ ì§„ í‚¤ì›Œë“œ ì¶”ì¶œ
                                keywords = pattern.split('|')
                                for keyword in keywords:
                                    # ì •ê·œì‹ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì ì œê±°
                                    keyword = re.sub(r'\\', '', keyword)
                                    if keyword and keyword not in keywords_from_patterns:
                                        keywords_from_patterns.append(keyword)
                    
                    # ì œëª©ì—ì„œ í‚¤ì›Œë“œ ì°¾ê¸°
                    if subject:
                        for keyword in keywords_from_patterns:
                            if keyword in subject and keyword not in found_keywords:
                                found_keywords.append(keyword)
                                if len(found_keywords) >= subject_keywords_count:
                                    break
        except Exception as e:
            self.update_log(f"subject_suspicious_patterns íŒ¨í„´ ì¶”ì¶œ ì˜¤ë¥˜: {e}")
            # ì˜¤ë¥˜ ë°œìƒ ì‹œ ëŒ€ì²´ ë°©ë²• ì‚¬ìš©
            if hasattr(self, 'log_text'):
                log_content = self.log_text.get("1.0", "end")
                impersonation_match = re.search(r'ì‚¬ì¹­ ì˜ì‹¬: \'([^\']+)\'ê°€ ì œëª©/ë°œì‹ ìì—', log_content)
                if impersonation_match:
                    keyword = impersonation_match.group(1)
                    if keyword not in found_keywords:
                        found_keywords.append(keyword)
        
        # í‚¤ì›Œë“œ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if subject_keywords_count > 0:
            summary += f"\n[ì œëª© ìœ„í—˜ í‚¤ì›Œë“œ: {subject_keywords_count}ê°œ ë°œê²¬]\n"
            if found_keywords:
                keywords_str = ', '.join(f'"{k}"' for k in found_keywords)
                summary += f" - ìœ„í—˜ í‚¤ì›Œë“œ: {keywords_str}\n"
            else:
                summary += f" - ìœ„í—˜ í‚¤ì›Œë“œê°€ ë°œê²¬ë˜ì—ˆìœ¼ë‚˜ ìƒì„¸ ë‚´ìš©ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"
        
        # ë„ë©”ì¸ í‰íŒ ì •ë³´ ì¶”ê°€
        if result.get('header') and result['header'].get('sender_domain'):
            sender_domain = result['header'].get('sender_domain', 'ì•Œ ìˆ˜ ì—†ìŒ')
            
            summary += f"\n[ë„ë©”ì¸ í‰íŒ] {sender_domain}\n"
        
        # ë„ë©”ì¸ ë‚˜ì´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        creation_date = None
        if result['header'].get('details') and result['header']['details'].get('domain_info'):
            domain_info = result['header']['details']['domain_info']
            # domain_age_daysëŠ” ì´ë¯¸ ìœ„ì—ì„œ ê°€ì ¸ì˜´
            creation_date = domain_info.get('creation_date')
        
        # ë„ë©”ì¸ í‰íŒ ìƒíƒœ í™•ì¸
        domain_reputation = result['header'].get('domain_reputation', 'unknown')
        
        # ë„ë©”ì¸ ë‚˜ì´ì— ë”°ë¥¸ í‰íŒ í‘œì‹œ - ì¬ì¡°ì • ì—¬ë¶€ì™€ ì‹¤ì œ í‰íŒ ìƒíƒœ ëª¨ë‘ ê³ ë ¤
        if domain_reputation_adjusted:
            # ì¡°ì •ëœ ê²½ìš° - ë‚˜ì´ì— ë”°ë¼ ì‹ ë¢° í‘œì‹œ
            summary += f" âœ… ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë„ë©”ì¸: {domain_age_days}ì¼ ì „ì— ë“±ë¡ëœ ë„ë©”ì¸ì…ë‹ˆë‹¤.\n"
        elif domain_reputation == "suspicious":
            # ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë„ë©”ì¸ (ì¡°ì •ë˜ì§€ ì•ŠìŒ)
            if domain_age_days:
                summary += f" âš ï¸ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë„ë©”ì¸: {domain_age_days}ì¼ ì „ì— ë“±ë¡ë˜ì—ˆìœ¼ë‚˜ ë„ë©”ì¸ í˜•ì‹ìœ¼ë¡œ ì¸í•´ ì˜ì‹¬ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.\n"
            else:
                summary += f" âš ï¸ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë„ë©”ì¸: í‰íŒ ë¶„ì„ì—ì„œ ì˜ì‹¬ ìš”ì†Œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n"
        elif domain_reputation == "established":
            # í™•ë¦½ëœ ë„ë©”ì¸
            if domain_age_days:
                summary += f" âœ… ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë„ë©”ì¸: {domain_age_days}ì¼ ì „ì— ë“±ë¡ëœ ë„ë©”ì¸ì…ë‹ˆë‹¤.\n"
            else:
                summary += f" âœ… ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë„ë©”ì¸: ì˜¤ëœ ê¸°ê°„ ë“±ë¡ë˜ì–´ ìˆëŠ” ë„ë©”ì¸ì…ë‹ˆë‹¤.\n"
        else:
            # ê¸°íƒ€ ìƒíƒœ
            if domain_age_days:
                if domain_age_days < 30:
                    summary += f" âš ï¸ ìµœê·¼({domain_age_days}ì¼ ì „)ì— ìƒì„±ëœ ë„ë©”ì¸ì…ë‹ˆë‹¤.\n"
                else:
                    summary += f" â„¹ï¸ {domain_age_days}ì¼ ì „ì— ë“±ë¡ëœ ë„ë©”ì¸ì…ë‹ˆë‹¤.\n"
            elif creation_date and creation_date != "Unknown":
                summary += f" â„¹ï¸ {creation_date}ì— ë“±ë¡ëœ ë„ë©”ì¸ì…ë‹ˆë‹¤.\n"
            else:
                summary += f" â„¹ï¸ ë„ë©”ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"
                
        # ë³¸ë¬¸ ë¶„ì„ ìš”ì•½
        if result['body']['total_matches'] > 0:
            summary += f"\n[ë³¸ë¬¸ ìœ„í—˜ íŒ¨í„´: {result['body']['total_matches']}ê°œ ë°œê²¬]\n"
            for category, info in result['body']['categories'].items():
                if 'examples' in info:
                    examples = ', '.join(f'"{ex}"' for ex in info['examples'][:3])
                    summary += f" - {category}: {info['count']}ê±´ (ë°œê²¬: {examples})\n"
                else:
                    summary += f" - {category}: {info['count']}ê±´\n"
        
        # ì²¨ë¶€ íŒŒì¼ ì •ë³´
        if result.get('attachments'):
            summary += f"\n[ì²¨ë¶€ íŒŒì¼: {len(result['attachments'])}ê°œ]\n"
            has_unsafe_attachment = False
            
            for i, att in enumerate(result['attachments'], 1):
                is_safe = att.get('safe', True)
                status_emoji = "âœ…" if is_safe else "âš ï¸"
                
                # ì•ˆì „í•˜ì§€ ì•Šì€ ì²¨ë¶€ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                if not is_safe:
                    has_unsafe_attachment = True
                    
                # íŒŒì¼ í¬ê¸° í˜•ì‹í™” (KB/MB ë‹¨ìœ„ë¡œ)
                size = att.get('size', 0)
                if size > 1048576:  # 1MB
                    formatted_size = f"{size/1048576:.2f} MB"
                elif size > 1024:  # 1KB
                    formatted_size = f"{size/1024:.1f} KB"
                else:
                    formatted_size = f"{size} ë°”ì´íŠ¸"
                    
                # íŒŒì¼ ìœ í˜•ì— ë”°ë¥¸ ì•„ì´ì½˜ ì¶”ê°€
                file_type = att.get('type', '').lower()
                file_icon = "ğŸ“„"  # ê¸°ë³¸ ë¬¸ì„œ
                if 'image' in file_type:
                    file_icon = "ğŸ–¼ï¸"
                elif 'pdf' in file_type:
                    file_icon = "ğŸ“‘"
                elif 'excel' in file_type or 'spreadsheet' in file_type:
                    file_icon = "ğŸ“Š"
                elif 'word' in file_type or 'document' in file_type:
                    file_icon = "ğŸ“"
                elif 'zip' in file_type or 'compressed' in file_type:
                    file_icon = "ğŸ—œï¸"
                elif 'executable' in file_type or 'application' in file_type:
                    file_icon = "âš™ï¸"
                    
                summary += f" {i}. {status_emoji} {file_icon} {att['filename']} ({formatted_size})\n"
                if att.get('reason'):
                    summary += f"    - ì°¸ê³ : {att['reason']}\n"
            
            # ì²¨ë¶€ íŒŒì¼ ì•ˆì „ì„±ì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª…
            if has_unsafe_attachment:
                summary += " âš ï¸ ì£¼ì˜: ì¼ë¶€ ì²¨ë¶€ íŒŒì¼ì´ ì ì¬ì  ìœ„í—˜ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
            else:
                summary += " âœ… ëª¨ë“  ì²¨ë¶€ íŒŒì¼ì´ ì•ˆì „í•œ ê²ƒìœ¼ë¡œ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n"

        # ê¸°ê´€ ìœ í˜• ì •ë³´ ì¶œë ¥
        if result.get('header') and result['header'].get('organization_type'):
            org_type = result['header']['organization_type']
            org_subtype = result['header'].get('organization_subtype', 'unknown')
            
            # ê¸°ê´€ ìœ í˜•ë³„ ì´ëª¨ì§€ ì¶”ê°€
            org_emoji = "ğŸ¢"
            if org_type == "public":
                org_emoji = "ğŸ›ï¸"
            elif org_type == "financial":
                org_emoji = "ğŸ¦"
            elif org_type == "education":
                org_emoji = "ğŸ“"
            elif org_type == "technology":
                org_emoji = "ğŸ’»"
            elif org_type == "user":
                org_emoji = "ğŸ‘¤"
            
            summary += f"\n[ë°œì‹ ì ê¸°ê´€ ìœ í˜•] {org_emoji} {org_type}/{org_subtype}\n"
            
            # ì‚¬ì¹­ ê°€ëŠ¥ì„± ê²½ê³  ì¶”ê°€
            if result['header'].get('impersonation') == 'suspected':
                summary += f" âš ï¸ ì‚¬ì¹­ ê°€ëŠ¥ì„± ìˆìŒ: {result['header'].get('impersonation_reason', '')}\n"
        
        # í—¤ë” ê²€ì¦ ì •ë³´ ìš”ì•½
        if result.get('header'):
            summary += "\n[í—¤ë” ê²€ì¦ ê²°ê³¼]\n"
            header_checks = {
                'spf_check': 'SPF ê²€ì¦',
                'dkim_check': 'DKIM ê²€ì¦',
                'dmarc_check': 'DMARC ê²€ì¦',
                'dnssec_status': 'DNSSEC'
            }
            
            for check, desc in header_checks.items():
                if check in result['header']:
                    status = result['header'][check]
                    if check == 'dnssec_status':
                        status_emoji = "âœ…" if status == "signed" else "â„¹ï¸"
                    else:
                        status_emoji = "âœ…" if status == "pass" or status == "match" else "âš ï¸" if status == "none" or status == "not_applicable" else "âŒ"
                    summary += f" {status_emoji} {desc}: {status}\n"

        # ìœ„í—˜ ìš”ì†Œ ë° ì¡°ì • ì„¤ëª… - ë¶„ì„ê¸°ì—ì„œ ì œê³µí•œ ì´ìœ  ëª©ë¡ ì‚¬ìš©
        summary += "\n[ìœ„í—˜ ìš”ì†Œ ë¶„ì„]\n"
        
        # ë¶„ì„ê¸°ì—ì„œ ì œê³µí•œ ì´ìœ  ëª©ë¡ ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€)
        if 'reasons' in result:
            for reason in result['reasons']:
                # ë„ë©”ì¸ í‰íŒ ê´€ë ¨ ì´ìœ ëŠ” í‰íŒì´ ì¡°ì •ëœ ê²½ìš° ì¡°ì • ë©”ì‹œì§€ë¡œ ëŒ€ì²´
                if "ë„ë©”ì¸ í‰íŒ ì˜ì‹¬" in reason and not "ì·¨ì†Œë¨" in reason and domain_reputation_adjusted:
                    domain_reputation_score = 25
                    summary += f" â€¢ <ì·¨ì†Œë¨> ë„ë©”ì¸ í‰íŒ ì˜ì‹¬: +{domain_reputation_score} (ë„ë©”ì¸ ë‚˜ì´ {domain_age_days}ì¼ë¡œ ì¸í•´ ì°¨ê°)\n"
                else:
                    summary += f" â€¢ {reason}\n"
        
        # ìœ„í—˜ë„ ì ìˆ˜
        summary += f"\n[ìœ„í—˜ë„] {risk_score}/{risk_threshold}\n"
        
        # ìœ„í—˜ë„ì— ë”°ë¥¸ ì‹œê°ì  í‘œí˜„
        if verdict == 'dangerous':
            summary += "ğŸ”´ ë†’ì€ ìœ„í—˜ - ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n"
        elif verdict == 'suspicious':
            summary += "ğŸŸ  ì¤‘ê°„ ìœ„í—˜ - ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
        else:  # legitimate
            summary += "ğŸŸ¢ ì•ˆì „ - ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n"
        
        summary += f"\nì„¸ì…˜ ê²½ë¡œ: analysis_result/{result['session_path']}"
        
        # ìš”ì•½ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        self.update_summary(summary)
    
    def update_summary(self, text):
        self.root.after(0, lambda: self._update_text(self.summary_text, text))
    
    def update_log(self, text):
        self.root.after(0, lambda: self._update_text(self.log_text, text + "\n"))
    
    def _update_text(self, text_widget, text):
        text_widget.config(state=tk.NORMAL)
        text_widget.insert(tk.END, text)
        text_widget.see(tk.END)
        text_widget.config(state=tk.DISABLED)
    
    def clear_text_areas(self):
        self.summary_text.config(state=tk.NORMAL)
        self.summary_text.delete(1.0, tk.END)
        self.summary_text.config(state=tk.DISABLED)
        
        self.log_text.config(state=tk.NORMAL)
        self.log_text.delete(1.0, tk.END)
        self.log_text.config(state=tk.DISABLED)
    
    def open_keyword_manager(self):
        if not self.keyword_manager_path.exists():
            messagebox.showerror("ì˜¤ë¥˜", f"í‚¤ì›Œë“œ ê´€ë¦¬ ë„êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {self.keyword_manager_path}")
            return
        
        try:
            import subprocess
            subprocess.Popen([sys.executable, str(self.keyword_manager_path)])
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"í‚¤ì›Œë“œ ê´€ë¦¬ ë„êµ¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    
    def open_result_folder(self):
        results_dir = self.base_dir / "analysis_result"
        if not results_dir.exists():
            os.makedirs(results_dir)
        
        try:
            import subprocess
            if sys.platform == 'win32':
                subprocess.Popen(['explorer', str(results_dir)])
            elif sys.platform == 'darwin':  # macOS
                subprocess.Popen(['open', str(results_dir)])
            else:  # Linux
                subprocess.Popen(['xdg-open', str(results_dir)])
        except Exception as e:
            messagebox.showerror("ì˜¤ë¥˜", f"ê²°ê³¼ í´ë” ì—´ê¸° ì‹¤íŒ¨: {e}")
    
    def _create_default_keywords_if_needed(self):
        """ê¸°ë³¸ í‚¤ì›Œë“œ íŒŒì¼ ìƒì„±"""
        # ë” ë§ì€ ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ ì¶”ê°€
        default_keywords = [
            {
                "category": "financial",
                "blackList_keywords": [
                    r"(ì‹ ì›|ê°œì¸ì •ë³´|ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸|ê³„ì¢Œ|OTP|ì‹ ë¶„ì¦|ì¹´ë“œ).{0,5}(í•„ìˆ˜|ì •ë³´|ì œì¶œ|í™•ì¸|ìš”ì²­|ì œê³µ)",
                    r"(ê³„ì •|ì´ìš©){0,5}(ì •ì§€|ì œí•œ)",
                    r"(ì…ê¸ˆ|ì†¡ê¸ˆ|ì¶œê¸ˆ){0,5}(ìš”ì²­|í™•ì¸|ê¸°í•œ)",
                    r"(ì¦‰ì‹œ|ë°”ë¡œ|ì‘ë‹µ|í™•ì¸){0,5}(ì‘ë‹µ|í•„ìˆ˜|í™•ì¸)",
                    r"(ì„¸ê¸ˆ|ì—°ê¸ˆ|ë³´í—˜ë£Œ){0,5}(ì§€ê¸‰|í™˜ê¸‰|í˜œíƒ|ê°ë©´)",
                    r"(ë§í¬|ì²¨ë¶€íŒŒì¼|ë‹¤ìš´ë¡œë“œ|ì••ì¶•íŒŒì¼){0,10}(í™•ì¸|í•„ìˆ˜|ìš”ë§|í´ë¦­|ì°¸ì¡°)",
                    r"(ë¹„ë°€ë²ˆí˜¸|ì¸ì¦ë²ˆí˜¸).{0,10}(ì…ë ¥|í™•ì¸|ì œì¶œ)",
                    r"(ì§€ê¸ˆ|ì¦‰ì‹œ).{0,5}(ì‹¤í–‰|í™•ì¸|ë‹¤ìš´ë¡œë“œ)"
                ]
            },
            {
                "category": "delivery",
                "blackList_keywords": [
                    r"(ë°°ì†¡|ì£¼ì†Œ|ë„ì°©|ë²ˆí˜¸|ë¬¼í’ˆ|ê²½ë¡œ|ì‹¤ì‹œê°„)\s{0,5}(ì •ë³´|ì‹¤íŒ¨|ì§€ì—°|í™•ì¸|ì˜¤ë¥˜)",
                    r"(ìˆ˜ì·¨ì¸|ìœ„íƒ|ìš´ì†¡ì¥)\s{0,5}(ë¶€ì¬|í™•ì¸)",
                    r"(ë„ì°©|ë°˜ì†¡|êµí™˜|í™˜ë¶ˆ|ê¸°ê°„)\s{0,5}(ì˜ˆì •|í™•ì¸|ì •ë³´)",
                    r"(ë§í¬|ì²¨ë¶€íŒŒì¼|ë‹¤ìš´ë¡œë“œ|ì••ì¶•íŒŒì¼)\s{0,10}(í™•ì¸|í•„ìˆ˜|ìš”ë§|í´ë¦­|ì°¸ì¡°)",
                    r"(ë¹„ë°€ë²ˆí˜¸|ì¸ì¦ë²ˆí˜¸).{0,10}(ì…ë ¥|í™•ì¸|ì œì¶œ)",
                    r"(ì§€ê¸ˆ|ì¦‰ì‹œ).{0,5}(ì‹¤í–‰|í™•ì¸|ë‹¤ìš´ë¡œë“œ)",
                    r"(ìš°ì²´êµ­|íƒë°°|ìš°í¸).{0,5}(ë°°ì†¡|ì•Œë¦¼|ì•ˆë‚´)",
                    r"(íŒ¨í‚¤ì§€|ì†Œí¬).{0,5}(ëŒ€ê¸°|ë³´ê´€|ë„ì°©)"
                ]
            },
            {
                "category": "investigation",
                "blackList_keywords": [
                    r"(ê²½ì°°ì„œ|ê²½ì°°)(\s{0,5}(ë°©ë¬¸|ì¡°ì‚¬|ì¶œì„))?|((ë°©ë¬¸|ì¡°ì‚¬|ì¶œì„)\s{0,5})?(ê²½ì°°ì„œ|ê²½ì°°)",
                    r"(ì‹ ë¶„ì¦)(\s{0,5}(ë°œê¸‰|ì‹ ì²­))?|((ë°œê¸‰|ì‹ ì²­)\s{0,5})?(ì‹ ë¶„ì¦)"
                ]
            },
            {
                "category": "malicious",
                "blackList_keywords": [
                    r"\b(ì¦‰ì‹œ|ì§€ê¸ˆë‹¹ì¥)\s{0,3}(í´ë¦­|ë‹¤ìš´ë¡œë“œ)\b",
                    r"(ë¹„ë°€ë²ˆí˜¸|ì£¼ë¯¼ë²ˆí˜¸)\s{0,5}ì…ë ¥\b",
                    r"\b(ê¸‰ì†|ì¤‘ìš”)\s{0,3}ì¡°ì¹˜\b"
                ]
            },
            {
                "category": "government",
                "blackList_keywords": [
                    r"(ë¯¼ì›|ì¦ëª…ì„œ)\s{0,3}(ë°œê¸‰|ì‹ ì²­)",
                    r"(í–‰ì •|êµ­ì„¸ì²­|ì„¸ë¬´ì„œ)\s{0,3}(ì•ˆë‚´|í†µë³´)",
                    r"(ì£¼ë¯¼ë“±ë¡|ì—¬ê¶Œ)\s{0,3}(ê°±ì‹ |ë§Œë£Œ)",
                    r"(ëŒ€íšŒ|ê²½ì§„ëŒ€íšŒ|ê³µëª¨ì „)\s{0,5}(ì°¸ê°€|ì‹ ì²­|ì ‘ìˆ˜|ì•ˆë‚´)",
                    r"(ìš´ì˜ìœ„ì›íšŒ|ì •ë³´|ì„¸ì¢…)\s{0,5}(ì•Œë ¤ë“œë¦½|ì•ˆë‚´|í†µë³´)",
                    r"(êµ­ë‚´|êµ­ì œ)\s{0,3}(ëŒ€í•™ìƒ|ì°¸ê°€ì)\s{0,5}(ëª¨ì§‘|ì•ˆë‚´|ì ‘ìˆ˜)"
                ]
            },
            {
                "category": "military",
                "blackList_keywords": [
                    r"(êµ°ì‚¬|ì‘ì „|í›ˆë ¨)\s{0,3}(ê¸°ë°€|ë¬¸ì„œ|ì§€ì¹¨)",
                    r"(ë™ì›|ë³‘ì—­|ì§•ì§‘)\s{0,3}(ì•ˆë‚´|ëª…ë ¹|í†µì§€)",
                    r"(êµ°ë²•|êµ°ì‚¬ë²•ì›)\s{0,3}(ì†Œí™˜|ì²˜ë¶„|íŒê²°)"
                ]
            },
            {
                "category": "education",
                "blackList_keywords": [
                    r"(í•™ì |ì„±ì |ì¥í•™ê¸ˆ)\s{0,3}(ë³€ê²½|í™•ì¸|ì§€ê¸‰)",
                    r"(ì…í•™|ì¡¸ì—…|ë“±ë¡)\s{0,3}(ì•ˆë‚´|í†µë³´|í™•ì¸)",
                    r"(í•™ìœ„|ìê²©ì¦)\s{0,3}(ì·¨ë“|ì¸ì¦|ë°œê¸‰)"
                ]
            }
        ]

        for keyword_set in default_keywords:
            filename = f"{keyword_set['category']}_keywords.json"
            file_path = self.keywords_dir / filename
            if not file_path.exists():
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(keyword_set, f, ensure_ascii=False, indent=2)
                print(f"ê¸°ë³¸ í‚¤ì›Œë“œ íŒŒì¼ ìƒì„±: {filename}")

def main():
    root = tk.Tk()
    app = EmailAnalyzerGUI(root)
    root.mainloop()

if __name__ == "__main__":
    main()